### 1.磁盘连接方式和设备文件名关系

> 例题：如果你的PC上面有两个SATA磁盘以及一个USB磁盘，而主板上面有六个SATA的插槽。这两个SATA磁盘分别安插在主板上的SATA1, SATA5插槽上， 请问这三个磁盘在Linux中的设备文件名为何？答：由于是使用侦测到的顺序来决定设备文件名，并非与实际插槽代号有关，因此设备的文件名如下：
>
> 1. SATA1插槽上的文件名：/dev/sda
> 2. SATA5插槽上的文件名：/dev/sdb
> 3. USB磁盘（开机完成后才被系统捉到）：/dev/sdc



柱面通常是文件系统的最小单位，也是分区的最小单位。



#### 磁盘分区——MBR方式

MBR是比较老的分区方式，通常旧的磁盘扇区大小为512字节，磁盘的第一个扇区存放有开机记录区MBR(Master Boot Record)和**分区表**。开机记录区MBR存放有**446字节**的开机管理程序，而剩下的分区表就装有**64字节**的分区表。

分区表存放的就是一条条记录，每条记录存放有一个分区的开始和结束**磁道号码**，而按照书中的意思一条记录要16字节（不止存放磁道号码，还有些相关信息），因此MBR的分区表**最多存4个(主要)分区的记录**。



> 假设上面的硬盘设备文件名为/dev/sda时，那么这四个分区在Linux系统中的设备文件名如下
> 所示， 重点在于文件名后面会再接一个数字，这个数字与该分区所在的位置有关喔！
> P1:/dev/sda1
> P2:/dev/sda2
> P3:/dev/sda3
> P4:/dev/sda4



**分区的好处**：

1. 数据分开，不会互相影响。例如，重装系统只会影响C盘不会影响D盘；
2. 性能考虑，例如，C盘的文件只会在第一个分区对应的柱面范围内查找；



**延伸分区**：

因为64字节的限制，MBR第一个扇区内最多4个记录，因此最多4个**主要分区**。**延伸分区**就是指用额外的扇区来记录更多的分区信息，延伸分区会在自己的最前面几个扇区记录自己的分区信息。

> 举个例子就明白到底是怎么回事：
>
> 假设有400个柱面，那么在那64字节中我们可以就分为两个主要分区P1和P2，其中P1用1~100的柱面，P2用101~400的柱面。
>
> 之后在P2的前面几个扇区中我们又可以存放分区记录（来将这个P2进一步细分为5个更小的分区），于是乎P2就被叫做延伸分区，而它细分出来的5个分区被叫做逻辑分区L1~L5。
>
> 同样的，上述的分区在Linux系统中的设备文件名分别如下：
> P1:/dev/sda1
> P2:/dev/sda2	// 3和4直接没有
> L1:/dev/sda5
> L2:/dev/sda6
> L3:/dev/sda7
> L4:/dev/sda8
> L5:/dev/sda9
>
> 设备文件名没有/dev/sda3与/dev/sda4呢？因为前面四个号码都是保留给Primary或Extended用的！所以逻辑分区的设备名称号码就由5号开始了

MBR最多只能有一个延伸分区（操作系统的限制）。主要分区Primary(P)，延伸分区Extended(E)。

MBR的缺点很多，例如：操作系统无法抓取到2.2T以上的磁盘容量，MBR只有一个区块破坏了就会GG，MBR的开机管理程序最多446字节很难受。因此会有下面的GPT分区格式。



#### 磁盘分区——GPT方式

GPT中512KB的扇区被称为逻辑区块位址**LBA**。GPT使用了34个LBA记录分区信息，同时在**末尾33个LBA作为LBA1~34的备份**（防止GG）。

LBA0和MBR类似，存放446字节的第一阶段开机程序，剩下的64字节存放GPT标志，传统MBR识别不了这64字节。

LBA1记录分区表本身位置和大小，也记录备份用的分区表的位置与大小。同时存放分区表的CRC32校验码，验证失败就会启动备份分区表恢复正常运行。

LBA2~34中每个LBA存放4条分区记录，因此每条记录就有128字节，比MBR的16字节大很多，其中用8字节记录磁道号，因此GPT能管理很大的范围。



### 2.BIOS与UEFI开机检测程序

**CMOS**是记录各项硬件参数且嵌入在主板上面的存储器，**BIOS**则是写入到主板的一个固件（固件就是硬件中的软件），BIOS就是开机时会主动执行的第一个程序。

**BIOS**会依据使用者的设置去取得能够开机的硬盘， 并且到该硬盘里面去读取第一个扇区的MBR位置。 MBR这个仅有446 Bytes的硬盘容量里面会放置最基本的开机管理程序Boot loader。

**开机管理程序**会去磁盘中读取**核心文件**，由于开机管理程序是操作系统在安装的时候所提供的，所以他会认识硬盘内的文件系统格式。之后的工作就是操作系统了。（开机管理程序是操作系统的亲戚）

PS：BIOS载入的是第一阶段的开机管理程序，还有可能有更进一步阶段的开机管理程序。



开机管理程序Boot loader不止可以安装在446字节的MBR中，还可以安装在每个分区的**开机扇区**Boot Sector中。

> 例如第一阶段boot loader开始运行后，就会弹出菜单让用户选择启动Windows还是Linux，选择哪个系统，则此loader就会转而去执行不同的第二阶段的loader从而将相应的操作系统加载进内存。

loader只会认识自己系统盘内的可开机**核心文件**和其它loader。

> Windows在安装的时候，他的安装程序会主动的覆盖掉MBR以及自己所在分区的开机扇区，你没有选择的机会， 而且他没有让我们自己选择菜单的功能。如果先安装Linux再安装Windows话，那MBR的开机管理程序就只会有Windows的项目，而不会有Linux的项目。



P142：UEFI BIOS 搭配 GPT 开机的流程